# name the compilers
CP = wpp386
CC = wcc386
WL = wlib
LL = wlink
WRC = wrc
ASM = JWasm
PCHDIR =

AFLAGS  = /DSTACK_CALL /nologo /Cx /c /WX /Zd /omf /Zp1 /Fl /Fd
CFLAGS  = /6s /d3 /od /s /wx /mf /hd /zp1 /v /fh=$(PCHDIR)lba.pch
LLFLAGS = OP CASEEXACT,STACK=7000,SYMF,MAP,DOSSEG,VERBOSE
LFLAGS  = /c /b /l

!ifeq BT NT
CFLAGS	+= /D_WIN32 /bt=NT
AFLAGS	+= /D_WIN32
LLFLAGS += SYSTEM win32 OP STUB=WIN\WINSTUB.EXE
OBJETS2 = JOYSTICK.OBJ
!else
CFLAGS  += /D_DOS4GW /bt=DOS /DDOS4GW
AFLAGS	+= /D_DOS4GW
LLFLAGS += SYSTEM dos4g DEBUG DWARF ALL
OBJETS2 = CRITICAL.OBJ HERCULE.OBJ HERCUL_A.OBJ KEYB.OBJ
!endif

!ifdef LBA2HD
CFLAGS += /DONE_GAME_DIRECTORY /DCDROM /DLBA_GAME
EXE_SUFFIX = LBA2HD
#/DDEBUG_TOOLS /DTEST_TOOLS
!else
!ifdef LBA2DEMO
CFLAGS += /DDEMO /DONE_GAME_DIRECTORY
EXE_SUFFIX = LBA2DEMO
#/DDEBUG_TOOLS
!else
CFLAGS  += /DDEBUG_TOOLS /DCDROM /DLBA_GAME
OBJETS2 +=
EXE_SUFFIX = DEBUG
!endif
!endif

#.SILENT

.EXTENSIONS:
.EXTENSIONS: .exe .obj .asm .c .cpp

VERSION	= VERSION.OBJ

OBJETS = BEZIER.OBJ FICHE.OBJ EXTRA.OBJ GLOBAL.OBJ INPUT.OBJ GRILLE.OBJ GRILLE_A.OBJ &
			FUNC.OBJ CHEATCOD.OBJ ANIMTEX.OBJ IMPACT.OBJ BUGGY.OBJ WAGON.OBJ FIRE.OBJ &
			PLASMA.OBJ POF.OBJ PATCH.OBJ GERETRAK.OBJ FLOW.OBJ FLOW_A.OBJ DART.OBJ &
			VALIDPOS.OBJ DEC_XCF.OBJ PLAYACF.OBJ COPY.OBJ MEM.OBJ COMPRESS.OBJ LZSS.OBJ &
			HOLOBODY.OBJ SORT.OBJ ZV.OBJ SCAN.OBJ MUSIC.OBJ

OBJETS += PERSO.OBJ DISKFUNC.OBJ INCRUST.OBJ AMBIANCE.OBJ GAMEMENU.OBJ GERELIFE.OBJ &
			OBJECT.OBJ SAVEGAME.OBJ INTEXT.OBJ EXTFUNC.OBJ RAIN.OBJ MESSAGE.OBJ &
			INVENT.OBJ COMPORTE.OBJ HOLOGLOB.OBJ HOLOPLAN.OBJ CONFIG.OBJ CREDITS.OBJ

LIB386_PATH = ..\LIB386
!ifeq BT NT
LIBS  = $(LIB386_PATH)\3D\NT_3D.LIB
LIBS += $(LIB386_PATH)\AIL\NT_AILS.LIB
LIBS += $(LIB386_PATH)\ANIM\NT_ANIS.LIB
LIBS += $(LIB386_PATH)\FILEIO\NT_FIOS.LIB
LIBS += $(LIB386_PATH)\MENU\NT_MENS.LIB
LIBS += $(LIB386_PATH)\OBJECT\NT_OBJ.LIB
LIBS += $(LIB386_PATH)\POL_WORK\NT_POLY.LIB
LIBS += $(LIB386_PATH)\SMACKER\NT_SMKS.LIB
LIBS += $(LIB386_PATH)\SVGA\NT_SVGS.LIB
LIBS += $(LIB386_PATH)\SYSTEM\NT_SYSS.LIB
LIBS += 3DEXT\NT_EXT.LIB
LIBS2 = winmm.lib strmiids.lib ddraw.lib
EXE   = LBA2_NT_$(EXE_SUFFIX)
!else
LIBS  = $(LIB386_PATH)\3D\DOS_3D.LIB
LIBS += $(LIB386_PATH)\AIL\DOS_AILS.LIB
LIBS += $(LIB386_PATH)\ANIM\DOS_ANIS.LIB
LIBS += $(LIB386_PATH)\FILEIO\DOS_FIOS.LIB
LIBS += $(LIB386_PATH)\MENU\DOS_MENS.LIB
LIBS += $(LIB386_PATH)\OBJECT\DOS_OBJ.LIB
LIBS += $(LIB386_PATH)\POL_WORK\DOS_POLY.LIB
LIBS += $(LIB386_PATH)\SMACKER\DOS_SMKS.LIB
LIBS += $(LIB386_PATH)\SVGA\DOS_SVGS.LIB
LIBS += $(LIB386_PATH)\SYSTEM\DOS_SYSS.LIB
LIBS += 3DEXT\DOS_EXT.LIB
LIBS2 =
EXE   = LBA2_DOS_$(EXE_SUFFIX)
!endif

BUILD_DIR = BUILD

# This is the GNU Make equivalent of CURDIR :=
CURDIR   = $+ $(%cdrive):$(%cwd) $-

!ifeq BT NT
$(BUILD_DIR)\$(EXE).exe: $(VERSION) $(LIBS) $(OBJETS) $(OBJETS2)
	*$(LL) Name $@ $(LLFLAGS) Library { $LIBS2 $LIBS } FILE { $OBJETS $OBJETS2 $VERSION }
	$(WRC) -q -ad WIN\LBA2.RES $@
!else
$(BUILD_DIR)\$(EXE).exe: $(VERSION) $(LIBS) $(OBJETS) $(OBJETS2)
	*$(LL) Name $@ $(LLFLAGS) Library { $LIBS2 $LIBS } FILE { $OBJETS $OBJETS2 $VERSION }
!endif

$(LIBS):
	cd $^:
	$(MAKE) "BT=$(BT)" "LBA2HD=$(LBA2HD)" "LBA2DEMO=$(LBA2DEMO)"
	@cd $(CURDIR)

.c.obj :
	$(CC) $^& $(CFLAGS)

.cpp.obj :
	$(CP) $^& $(CFLAGS)

.asm.obj :
	$(ASM) $(AFLAGS) $^&.ASM

$(VERSION): VERSION.CPP $(OBJETS)
	$(CP) VERSION $(CFLAGS)

MESSAGE.OBJ: MESSAGE.CPP
	del $(PCHDIR)lba.pch
	$(CP) MESSAGE $(CFLAGS)

GAMEMENU.OBJ: GAMEMENU.CPP
	del $(PCHDIR)lba.pch
	$(CP) GAMEMENU $(CFLAGS)

clean: .SYMBOLIC
	@cd $(CURDIR)\..
	del /s /q *.obj
	del /s /q *.lib
	del /s /q *.err
	del /s /q *.ld
	del /s /q *.map
	del /s /q *.pch
	del /s /q *.lst
	del /s /q *.def
	del /s /q *.sym
	@cd $(CURDIR)
